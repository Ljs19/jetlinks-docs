# 国际化

## 应用场景
 国际化i18n 全称 Internationalization，
 因为单词太长，所以中间的 18 个字母被缩写为 18，再加上开头和结尾的字母，就组成了 i18n。
 i18n可以帮助我们对网站进行多语言翻译，让它们可以轻松适应使用不同语言用户的需求

在`1.10.0`版本`后端`增加了国际化支持

## 指导介绍

   <p>1. <a href="/dev-guide/i18n.html#通用国际化" >通用国际化</a></p>
   <p>2. <a href="/dev-guide/i18n.html#规则引擎相关国际化" >规则引擎相关国际化</a></p>
   <p>3. <a href="/dev-guide/i18n.html#jsr303" >jsr303</a></p>
   <p>4. <a href="/dev-guide/i18n.html#编程式使用" >编程式使用</a></p>


## 通用国际化

相关配置

在每个maven模块的`resources`下增加文件`i18n/{path}/{name}_{lang}_{region}.properties`:

1. {path}为子目录名,可建立多级.
2. {name}为文件名,不能包含下划线(_)
3. {lang}为语言,如: zh,en
4. {region}为地区,如: CN,US

例:

```s
--resources
-----|---i18n
-----|----|---module1
-----|----|----|--messages_zh_CN.properties
-----|----|----|--messages_en_US.properties
```

::: warning
不同的模块使用的`路径+文件名`不能相同.
:::

`resources/I18n/messages_en_US.properties`的文件内容格式:

```text
org.jetlinks.pro.standalone.taskexecutor.CustomTaskExecutorI18n.notSupport=data_num_does_not_support：{0}
```


方式一：异常方式

在API请求抛出异常时，`message`设置为对应的`key`，如:

```java
throw new IllegalArgumentException("org.jetlinks.pro.standalone.taskexecutor.notSupport");
```

在需要参数化动态生成消息的时候,需要使用实现`I18nSupportException`的接口.并传入`args`，如:

```java
throw new I18nSupportException("org.jetlinks.pro.standalone.taskexecutor.CustomTaskExecutorI18n.notSupport",_num);
```

```java
public I18nSupportException(String code, Object... args) {
        super(code);
        this.i18nCode = code;
        this.args = args;
    }
```

方式二：枚举类方式

在API调用时,平台会将实现了`EnumDict`接口的枚举序列化为一个对象:

```json
{
    "value":"枚举标识",
    "num":"匹配值",
    "text":"说明"
}
```

`text`支持使用国际化来展示.

使用: 枚举实现接口`I18nEnumDict`即可.在序列化时,会使用`{className}.{enumName}`作为`key`进行转换.
例如:

在`org.jetlinks.pro.standalone.taskexecutor`建立枚举类

```java
package org.jetlinks.pro.standalone.taskexecutor;

@Getter
@Dict()
@AllArgsConstructor
public enum CustomTaskExecutorI18n implements I18nEnumDict<String> {
    notActive(1,"未启用"),
    offline(2,"离线"),
    online(3,"在线");
    //枚举匹配值
    private final int num;
    //枚举值说明
    private final String text;

    @Override
    public String getValue() {
        return name();
    }

    public static String check(Integer num) {
        for (CustomTaskExecutorI18n value : values()) {
            if (value.getNum()==num){
                return value.text;
            }
        }
        return null;
    }
}

```

2.构建controller根据传入值进行返回

```java

@RequestMapping("/I18n")
@RestController
@Tag(name = "枚举值返回")
@Authorize(ignore = true)
public class CustomController {
    @PostMapping("/{_num}")
    public String getI18n(@PathVariable Integer _num) {
        String text = CustomTaskExecutorI18n.check(_num);
        if (text == null) {
            throw new I18nSupportException("org.jetlinks.pro.standalone.taskexecutor.CustomTaskExecutorI18n.notSupport",_num);
        }
        return text;
    }
}
```


## 规则引擎相关国际化

<div class='explanation primary'>
  <p class='explanation-title-warp'>
    <span class='iconfont icon-bangzhu explanation-icon'></span>
    <span class='explanation-title font-weight'>提示</span>
  </p>
    规则引擎前端引用的是<code>NODE-RED</code>，与通用国际化无关
</div>

NODE-RED相关资料参考: [NODE-RED官网](https://nodered.org/)

<div class='explanation primary'>
  <p class='explanation-title-warp'>
    <span class='iconfont icon-bangzhu explanation-icon'></span>
    <span class='explanation-title font-weight'>提示</span>
  </p>
    <p>可以配置参数切换主时区</p>
    <p>-Duser.language=en -Duser.region=US</p>
</div>

  以美国地区示例：
```java
   //en:代表语言
  -Duser.language=en
   //US:代表地区
  -Duser.region=US

```
 jar方式：
在启动时加上参数：
```java
-Duser.language=en -Duser.region=US
```
 docker镜像方式
<div class='explanation primary'>
  <p class='explanation-title-warp'>
    <span class='iconfont icon-bangzhu explanation-icon'></span>
    <span class='explanation-title font-weight'>说明</span>
  </p>
     <p>镜像可以使用平台提供的后端的镜像(JetLinks)</p>
     <p> 也可以自己将应用程序打成镜像包,参考：<a href="/dev-guide/java-deploy.html">使用docker部署后端</a></p>
</div>

将jetlinks后端代码`jetlinks-pro\dist\docker-compose.yml`文件中的`jetlinks`镜像的`environment`参数上加如下配置：
```yaml
 - "JAVA_OPTS=-Duser.language=en -Duser.region=US"
```


规则引擎节点实现i18n国际化支持

editor文档国际化

获取node-red国际化文件  [node-red国际化文件](https://github.com/node-red/node-red/tree/master/packages/node_modules/%40node-red/editor-client/locales).

将平台的`jetlinks-pro\jetlinks-manager\rule-engine-manager\src\main\resources\static\rule-editor\locales`目录整理成如下结构

<div class='explanation primary'>
  <p class='explanation-title-warp'>
    <span class='iconfont icon-bangzhu explanation-icon'></span>
    <span class='explanation-title font-weight'>提示</span>
  </p>
    <p>文档中的zh-CN目录JSON文件，为原来平台<code>jetlinks-pro\jetlinks-manager\rule-engine-manager\src\main\resources\static
\rule-editor\locales</code>目录下JSON文件</p>
<p>en-US下node-red.json文件是对zh-CN目录node-red.json文件的翻译</p>
</div>

![locale结构图](./images/custom-rule-engine-locales.png)


利用代码块中资源加载路劲替换接口中原有加载路劲

1.`org.jetlinks.pro.rule.engine.web.editor.RuleEngineEditorController/locales/editor`
```java
static/rule-editor/locales/"+Locale.getDefault().toString().replace("_","-")+"/editor.json").getInputStream()
```

2.`org.jetlinks.pro.rule.engine.web.editor.RuleEngineEditorController/locales/infotips`
```java
static/rule-editor/locales/"+Locale.getDefault().toString().replace("_","-")+"/infotips.json").getInputStream()
```

3.`org.jetlinks.pro.rule.engine.web.editor.RuleEngineEditorController/locales/jsonata`
```java
static/rule-editor/locales/"+Locale.getDefault().toString().replace("_","-")+"/jsonata.json").getInputStream()
```

4.`org.jetlinks.pro.rule.engine.web.editor.RuleEngineEditorController/locales/node-red`
```java
InputStream stream = new ClassPathResource("static/rule-editor/locales/"+Locale.getDefault().toString().replace("_","-")+"/node-red.json").getInputStream()
```

helper文档国际化

 1.使用如下helper路径替换MyCustomExecutorProvider类@EditorResource注解中的helper路径
 MyCustomExecutorProvider类：[自定义规则节点类MyCustomExecutorProvider](/dev-guide/rule-engine.html#自定义规则节点)
```java
 helper = "rule-engine/i18n/{local}/common/2-custom-node.html",
```
<div class='explanation primary'>
  <p class='explanation-title-warp'>
    <span class='iconfont icon-bangzhu explanation-icon'></span>
    <span class='explanation-title font-weight'>说明</span>
  </p>
   <p><code>helper = "rule-engine/i18n/{language}/common/custom-node.html</code></p>
   <p>{locale}代表一种语言以及国家/地区</p>
   <p>程序启动时会在<code>org.jetlinks.pro.rule.engine.editor.resolve(Locale locale, String resourcePath)
   </code>方法中替换成真正的路径，如被zh-CN、en-US或者其他替代</p>
</div>


在`jetlinks-pro\jetlinks-components\rule-engine-component\src\main\resources\rule-engine\i18n`下创建I18n en-US相关的html文件

文档内容根据自己的业务需要填写,`jetlinks-pro\jetlinks-components\rule-engine-component\src\main\resources\rule-engine\i18n/en-US/common/2-custom-node.html`
此处文档只是简单的示例
```html
<script type="text/html" data-help-name="custom">
    <p>custom node</p>
    <h3>example</h3>
    <code>
    <pre>
    id:d1257d60.3add8
    name:custom i18n
    </pre>
    </code>
</script>
```


helper文档国际化完成后，整体包文档结构图如下：

![i18n文档结构图](./images/i18n-01.png)





## jsr303

正常使用jsr303相关注解即可.

如果注解中指定了`message`,并且没有使用jsr303的国际化,则会使用这个message作为key进行国际化.
如果没有指定`message`,则使用`validation.property_validate_failed={0}{1}`进行国际化提示.
`{0}`为实体类属性名,`{1}`为jsr303的消息.

如果需要将实体类属性名也进行国际化,需要在启动参数中添加`-Di18n.validation.property.enabled=true`.
然后在`国际化配置文件`中增加`{className}.{property}`的key即可.

## 编程式使用

具体查看工具类 [LocaleUtils](https://github.com/hs-web/hsweb-framework/blob/master/hsweb-core/src/main/java/org/hswebframework/web/i18n/LocaleUtils.java).


## 常见问题

### 配置了jvm参数，在浏览器中：国际化相关配置不生效？

<div class='explanation warning'>
  <p class='explanation-title-warp'>
    <span class='iconfont icon-bangzhu explanation-icon'></span>
    <span class='explanation-title font-weight'>问题5</span>
  </p>
    <p>
        Q：配置了jvm参数，在浏览器中：国际化相关配置不生效？
    </p>
    <p>
        A：对应得浏览器也应该设置相应语言才会生效，如chrome浏览器，需要<code>settings-Languages-Preferred languages</code>
设置浏览器首选语言
/common/custom-node.html</code>
</p>
    </p>
</div>
